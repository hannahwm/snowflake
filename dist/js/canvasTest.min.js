/*! project-name v0.0.1 | (c) 2020 YOUR NAME | MIT License | http://link-to-your-git-repo.com */
var $=jQuery;!(function(e){var t=t||{};e.fn.canvasTest=function(e){return this.each((function(){Object.create(t.canvasTest).init(this,e)}))},e.fn.canvasTest.options={canvasId:"canvas",saveBtn:"#save",clearBtn:"#clear",undoBtn:"#undo"},t.canvasTest={init:function(t,n){this.$container=e(t),this.options=e.extend({},e.fn.canvasTest.options,n),this.bindElements(),this.bindEvents()},bindElements:function(){const t=this;if(drawing=!1,startX=0,startY=0,endX=0,endY=0,imageData=null,moves=[],isTouch=!1,mousePos={x:0,y:0},tinyDevice=!1,smallDevice=!1,e(window).width()<440){document.getElementById(t.options.canvasId).remove();const n=document.createElement("canvas");n.id="canvas",n.width=300,n.height=300,e(".canvas-wrapper").append(n),tinyDevice=!0}else if(e(window).width()<640){document.getElementById(t.options.canvasId).remove();const n=document.createElement("canvas");n.id="canvas",n.width=400,n.height=400,e(".canvas-wrapper").append(n),smallDevice=!0}},bindEvents:function(){const t=document.getElementById(this.options.canvasId),n=t.getContext("2d");function o(e,t){var n=e.getBoundingClientRect();return{x:t.touches[0].clientX-n.left,y:t.touches[0].clientY-n.top}}t.addEventListener("mousedown",this.startPosition),t.addEventListener("mouseup",this.endPosition),t.addEventListener("mousemove",this.draw),t.addEventListener("touchstart",(function(e){isTouch=!0,mousePos=o(t,e);const n=new MouseEvent("mousedown",{});t.dispatchEvent(n)}),!1),t.addEventListener("touchend",(function(e){isTouch=!0;const n=new MouseEvent("mouseup",{});t.dispatchEvent(n)}),!1),t.addEventListener("touchmove",(function(e){isTouch=!0,mousePos=o(t,e);const n=new MouseEvent("mousemove",{});t.dispatchEvent(n)}),!1),document.body.addEventListener("touchmove",(function(e){e.target==t&&e.preventDefault()}),{passive:!1}),e(this.options.saveBtn).on("click",(function(e){Canvas2Image.saveAsJPEG(t,600,600)})),e(this.options.clearBtn).on("click",(function(e){n.clearRect(0,0,t.width,t.height),moves=[]})),e(this.options.undoBtn).on("click",this.undoLast)},startPosition:function(e){const t=this.getContext("2d");!0===isTouch?(startX=mousePos.x,startY=mousePos.y):(startX=e.offsetX,startY=e.offsetY),imageData=t.getImageData(0,0,this.width,this.height),drawing=!0},endPosition:function(e){const t=document.getElementById("canvas").getContext("2d");tinyDevice?t.lineWidth=2:smallDevice?t.lineWidth=3:t.lineWidth=4,t.lineCap="round",t.moveTo(startX,startY),t.lineTo(endX,endY),t.strokeStyle="#ffffff",t.stroke(),t.beginPath(),drawing=!1;let n={x:0,y:0};n=tinyDevice?{x:150,y:150}:smallDevice?{x:200,y:200}:{x:300,y:300};const o=6;startX,startY,Math.PI;function s(e,t,n,o={}){const s=e.x-t.x,i=e.y-t.y,a=Math.cos(n),c=Math.sin(n);return o.x=s*a-i*c+t.x,o.y=s*c+i*a+t.y,o}function i(e,t,o=[]){const i=2*Math.PI/t;o.push(e);for(let a=1;a<t;a++)o.push(s(e,n,a*i));return o}function a(e,t,n,o,s={}){return s.x=(e.x-o.x)*(t?-1:1)+o.x,s.y=(e.y-o.y)*(n?-1:1)+o.y,s}function c(e,t,s=[]){for(let t=0;t<o;t++)s.push(a({x:e[t].x,y:e[t].y},!0,!1,n));return s}const r=i({x:startX,y:startY},o),d=i({x:endX,y:endY},o),v=c(r),y=c(d);for(let e=0;e<r.length;e++)moves.push({move:{start:{x:r[e].x,y:r[e].y},end:{x:d[e].x,y:d[e].y}}});for(let e=0;e<v.length;e++)moves.push({move:{start:{x:v[e].x,y:v[e].y},end:{x:y[e].x,y:y[e].y}}})},undoLast:function(){const e=document.getElementById("canvas"),t=e.getContext("2d");for(let e=0;e<12;e++)moves.pop();if(!(moves.length<0)){t.clearRect(0,0,e.width,e.height);for(var n=0;n<moves.length;n++){var o=moves[n];tinyDevice?t.lineWidth=2:smallDevice?t.lineWidth=3:t.lineWidth=4,t.lineCap="round",t.beginPath(),t.moveTo(o.move.start.x,o.move.start.y),t.lineTo(o.move.end.x,o.move.end.y),t.strokeStyle="#ffffff",t.stroke(),t.beginPath(),t.moveTo(o.move.end.x,o.move.end.y)}}},draw:function(e){const t=document.getElementById("canvas").getContext("2d");if(!drawing)return;!0===isTouch?(endX=mousePos.x,endY=mousePos.y):(endX=e.offsetX,endY=e.offsetY);let n={x:0,y:0};n=tinyDevice?{x:150,y:150}:smallDevice?{x:200,y:200}:{x:300,y:300};const o=6;startX,startY,Math.PI;function s(e,t,n,o={}){const s=e.x-t.x,i=e.y-t.y,a=Math.cos(n),c=Math.sin(n);return o.x=s*a-i*c+t.x,o.y=s*c+i*a+t.y,o}function i(e,t,o=[]){const i=2*Math.PI/t;o.push(e);for(let a=1;a<t;a++)o.push(s(e,n,a*i));return o}function a(e,t,n,o,s={}){return s.x=(e.x-o.x)*(t?-1:1)+o.x,s.y=(e.y-o.y)*(n?-1:1)+o.y,s}function c(e,t,s=[]){for(let t=0;t<o;t++)s.push(a({x:e[t].x,y:e[t].y},!0,!1,n));return s}const r=i({x:startX,y:startY},o),d=i({x:endX,y:endY},o),v=c(r),y=c(d);t.putImageData(imageData,0,0),tinyDevice?t.lineWidth=2:smallDevice?t.lineWidth=3:t.lineWidth=4,t.lineCap="round",t.moveTo(startX,startY),t.lineTo(endX,endY),t.strokeStyle="#ffffff",t.stroke(),t.beginPath(),t.moveTo(endX,endY),t.moveTo(r[1].x,r[1].y),t.lineTo(d[1].x,d[1].y),t.stroke(),t.beginPath(),t.moveTo(d[1].x,d[1].y),t.moveTo(r[2].x,r[2].y),t.lineTo(d[2].x,d[2].y),t.stroke(),t.beginPath(),t.moveTo(d[2].x,d[2].y),t.moveTo(r[3].x,r[3].y),t.lineTo(d[3].x,d[3].y),t.stroke(),t.beginPath(),t.moveTo(d[3].x,d[3].y),t.moveTo(r[4].x,r[4].y),t.lineTo(d[4].x,d[4].y),t.stroke(),t.beginPath(),t.moveTo(d[4].x,d[4].y),t.moveTo(r[5].x,r[5].y),t.lineTo(d[5].x,d[5].y),t.stroke(),t.beginPath(),t.moveTo(d[5].x,d[5].y),t.moveTo(v[0].x,v[0].y),t.lineTo(y[0].x,y[0].y),t.stroke(),t.beginPath(),t.moveTo(y[0].x,y[0].y),t.moveTo(v[1].x,v[1].y),t.lineTo(y[1].x,y[1].y),t.stroke(),t.beginPath(),t.moveTo(y[1].x,y[1].y),t.moveTo(v[2].x,v[2].y),t.lineTo(y[2].x,y[2].y),t.stroke(),t.beginPath(),t.moveTo(y[2].x,y[2].y),t.moveTo(v[3].x,v[3].y),t.lineTo(y[3].x,y[3].y),t.stroke(),t.beginPath(),t.moveTo(y[3].x,y[3].y),t.moveTo(v[4].x,v[4].y),t.lineTo(y[4].x,y[4].y),t.stroke(),t.beginPath(),t.moveTo(y[4].x,y[4].y),t.moveTo(v[5].x,v[5].y),t.lineTo(y[5].x,y[5].y),t.stroke(),t.beginPath(),t.moveTo(y[5].x,y[5].y)}}})($),$(document).ready((function(){$(".canvas-wrapper").canvasTest()}));